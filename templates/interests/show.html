{% extends "user/base.html" %}

{% block content %}
{% load staticfiles %}
{% load customtags %}

{% block extra_js %}
<script>
$('#interest-categories').affix({
  offset: {
    top: 100,
    bottom: function () {
      return (this.bottom = $('.footer').outerHeight(true))
    }
  }
})
</script>
{% endblock %}

<div class="row">
  <div class="col-sm-4"></div>
  <div class="col-sm-4">
    <div class="input-group" style="width: 100%; margin-bottom: 5%;">
      <input type="text" class="form-control" placeholder="Search">
    </div>
  </div>
</div>

<div class="row">
  <div class="col-sm-2"></div>
  <div class="col-sm-2" align="right">
    <div id="interest-categories">
      <ul class="nav">
	<li>Academics</li>
	<li>Extracurrix</li>
	<li>Other</li>
      </ul>
    </div>
  </div>
  
  <div class="col-sm-4">
    <ul class="panel panel-default panel-body">
      {% for interest in i_list.children %} 
      {%include "interests/interest_template.html" %}
      {% endfor %}
    </ul>
    
    <form id="sendinterests" method="POST">
      {% csrf_token %}
      <button class="btn btn-success" type="submit">Submit</button>
    </form>
  </div>
  
  <div class="col-sm-2 panel panel-default">
    <ul class="panel-body" id="interest-name-list"></ul>
  </div>
  
  <div class="col-sm-2"></div>
  
</div>



<script> 
	var interestlist = []

	UpdateInterestList = function() {
		$('#interest-name-list').empty()
		$.each(interestlist, function(i, val) {
			$('#interest-name-list').append($('<li/>').text(val.name))
		});
	}

	AddToInterestList = function(interest) {
		interest["priority"] = 1
		interestlist = interestlist.concat(interest)
		UpdateInterestList()
	}

	var sort_by = function(field, reverse, wrapperfunc){
		// wrapperfunc 
		var key = wrapperfunc ? 
		   function(x) {return wrapperfunc(x[field])} : 
		   function(x) {return x[field]};

		reverse = [-1, 1][+!!reverse];

		return function (a, b) {
		   return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
		}
	}

	user_interests = {{user_interests|safe}}

	user_interests.forEach(function(interest) {
		AddToInterestList(interest)		
	})

	$(".selectbtn").click(function(element) {
		jsn = JSON.parse(element.toElement.firstElementChild.textContent)
		ids = $.map(interestlist, function(val, index) {return val.id})
		if ((x = $.inArray(jsn.id, ids)) != -1) {
			interestlist[x]["priority"] += 1
			if (interestlist[x]["priority"] == 3) {
				interestlist.splice(x, 1)
			} else {
				interestlist.sort(sort_by('priority', false))
			}
		} else {
			jsn["priority"] = 1
			interestlist.push(jsn)
		}

		UpdateInterestList()
	})

	// TODO: Shamelessly copied and pasted from Diana's chat.js file...
	// Should probably put it in its own common js file

	// This function gets cookie with a given name
	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie != '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

	/*
	The functions below will create a header with csrftoken
	*/

	function csrfSafeMethod(method) {
	    // these HTTP methods do not require CSRF protection
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}
	function sameOrigin(url) {
	    // test that a given url is a same-origin URL
	    // url could be relative or scheme relative or absolute
	    var host = document.location.host; // host + port
	    var protocol = document.location.protocol;
	    var sr_origin = '//' + host;
	    var origin = protocol + sr_origin;
	    // Allow absolute or scheme relative URLs to same origin
	    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
	        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
	        // or any other URL that isn't scheme relative or absolute i.e relative.
	        !(/^(\/\/|http:|https:).*/.test(url));
	}

	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
			// Send the token to same-origin, relative URLs only.
			// Send the token only if the method warrants CSRF protection
			// Using the CSRFToken value acquired earlier
				xhr.setRequestHeader("X-CSRFToken", csrftoken);
		}}
	});

	$("#sendinterests").on('submit', function(event) {
		// TODO: Return id and priority only in the interest of speed?
		// var interests = $.map(interestlist, function(val, index) {return val.id val.priority})
	    $.ajax({
		    url : "/interest/update/", 
			type : "POST", 
			data : { interestlist : interestlist }, 
			
		    success : function(json) {

		    },
			
		    error : function(xhr,errmsg,err) {

		    }
		});

	})



</script>




{% endblock %}
