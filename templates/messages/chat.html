{% extends "user/base.html" %}
{% load static %}

{% block extrastyle %}
  <link rel="stylesheet" type="text/css" href="{% static 'messages/css/chat.css' %}" />
{% endblock %}


{% block extra_js %}
<script>
// these functions live here rather than in the js file because 
// they deal with django variables, which I don't know how to pass
// to the separate js file :( -ds

function getLoggedInUserEmail() {
  return "{{ user.email }}";
}

// CHANGE THIS TO BE FIRSTNAME/LASTNAME EVENTUALLY
function getMatchedUserEmails() {
  var emails = [];
  {% for user in matched_users %}
    emails.push( "{{user.email}}" );
  {% endfor %}

  return emails;
}
</script>
<script type="text/javascript" src="{% static 'messages/js/chat.js' %}"></script>
<script type="text/javascript" src="{% static 'messages/js/typeahead.jquery.js' %}"></script>

<script>
</script>
{% endblock %}

{% block content %}
<div class="row col-md-offset-2 col-md-8" id="chatroom-messages-row">
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-success alert-dismissible fade in" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
    <strong>Nudge alert!</strong> {{ message }}
  </div>
  {% endfor %}
  {% endif %}
</div>

<div class="row" style="height:100%; padding: 10px;" id="chat-room">
  <!--left navbar-->
  <div class="col-md-2 col-md-offset-2 well" id="inbox">    
    <!--chat menu dropdown-->
    <div class="btn-group btn-group-justified" id="btn-chat-menu">
      <div class="btn-group" id="btn-chat-menu">
	<button type="button" class="btn btn-success btn-large dropdown-toggle" id="chatmenu" data-toggle="dropdown" aria-expanded="false">
	  Menu <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu">
	  <li><a href="{% url 'settings' %}">Change Settings</a></li>
    <li><a href="{% url 'change_password' %}">Change Password</a></li>
	  <li><a href="/interest/show/">Adjust Interests</a></li>
	  <li><a data-toggle="modal" data-target="#sendFeedbackModal">Submit Feedback</a></li>
	  <li><a data-toggle="modal" data-target="#referAFriendModal">Refer a Friend</a></li>
    <li><a href="{% url 'logout' %}">Logout</a></li>
	</ul>
      </div>
    </div>      
    <!--inbox-->
    <ul class="nav nav-pills nav-stacked">
    {% for thread in inbox_threads %}
      <li role="presentation"><a class="inbox-message" href="#" 
				 onclick="populateThread({{ thread.pk }})" 
				 id="thread-link-{{ thread.pk }}">
	  {% if thread.members.count == 1 %}myself {% endif %}

	  {% for member in thread.members.all %}
	    {% ifnotequal member user %}
    	      {% if not forloop.first%}
	        , 
	      {% endif%}
	      {{ member.firstname }} {{ member.lastname }}
	    {% endifnotequal %}
	  {% endfor %}
      </a></li>
    {% endfor %}
    </ul>

    <form id="match-me" method="GET">
      <button type="submit" class="btn btn-danger btn-large btn-match-me" id="btn-match-me">Match Me!</button>
    </form>

  </div>
  <!--current message-->
  <div class="col-md-6 well box">
    <div class="row" id="thread-title-bar">
      <!--Title of message-->
      <div class="col-md-10" style="padding-left: 0px;">
	{% for thread in inbox_threads %}
	<div class="thread" id="members-in-thread-{{ thread.pk }}">
	  {% if thread.members.all.count == 1 %}
	  <h3 id="solo-chat">looks like it's only you in this chat, 
	    <a data-toggle="modal" data-target="#addPersonToThread">add a friend?</a></h3>
	  <h5 id="list-of-members-{{ thread.pk }}"></h5>
	  {% endif %}
	  {% if thread.members.all.count == 2 %}
	  <h3 id="list-of-members-{{ thread.pk }}">
	    {% for member in thread.members.all %}
	      {% ifnotequal member user %}
	        {{ member.firstname }} {{ member.lastname }}
	      {% endifnotequal %}
	    {% endfor %}
	  </h3>
	  {% endif %}
	  {% if thread.members.all.count > 2 %}
	  <h5 id="list-of-members-{{ thread.pk }}"><b>Members: </b>
	    {% for member in thread.members.all %}
	      {% ifnotequal member user %}
  	        {% if not forloop.first %}
	          , 
	        {% endif %}
  	        {{ member.firstname }} {{ member.lastname }}
	      {% endifnotequal %}
	    {% endfor %}
	  </h5>
	  {% endif %}
	</div>
	{% endfor %}
      </div>
      <div class="col-md-2" style="padding: 0;">
	<!--plus menu-->
	<div class="dropdown">
	  <button class="btn btn-success dropdown-toggle pull-right" type="button" id="plusmenu" data-toggle="dropdown" aria-expanded="false">+</button>
	  <ul class="dropdown-menu pull-right" role="menu" aria-labelledby="plusmenu">
	    <li><a data-toggle="modal" data-target="#addPersonToThread">Add a Person</a></li>
	    <li><a data-toggle="modal" data-target="#reportAPersonModal">Report Conversation</a></li>
	    <li><a data-toggle="modal" data-target="#nudgeAPersonModal">Nudge Person</a></li>
	  </ul>
	</div>
    </div>
    </div>
    <div id="message-box" class="row" style="margin-bottom: 5px;">
      <!--previously sent/received messages-->
      <div id="message-content">
	{% for thread in inbox_threads %}
 	<div id="thread-{{ thread.pk }}" class="thread thread-messages">
          {% for message in thread.message_set.all reversed %}
	  <div class="row" style="margin-top: 10px">
            {% if message.sender == user %}
	    <p class="chat-message sent pull-right">{{ message }}</p>
            {% else %}
            <p class="chat-message received pull-left">{{ message }}</p>
            {% endif %}
	  </div>
	  {% endfor %}
	</div>
	{% endfor %}
	<div class="clearfix" style="margin: 5px;"></div>
      </div>
    </div>
    <form id="send-message-form" method="POST">
      {% csrf_token %}
      <div class="input-group" id="send-message-row">
	<textarea class="form-control custom-control" id="message-input-box" rows="1" style="height: 1em;"></textarea>
	<!--input class="form-control" type="text" id="message-input-box"-->
	<span class="input-group-btn">
	  <input type="submit" id="btn-send-message" value="Send" class="btn btn-success"/>
	</span>
      </div>
    </form>
  </div>
</div>


<!-- Add Person to Thread Modal -->
<div class="modal fade" id="addPersonToThread" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Add to this Thread</h4>
      </div>
      <div class="modal-body">
        <form id="add-person-to-thread-form" method="POST">
	  {% csrf_token %}
	  <div id="scrollable-dropdown-menu">
	    <input class="form-control" type="text" id="add-person-to-thread-input" placeholder="Search by name..." autocomplete="off"/>
	  </div>
    <br>
    <button type="submit" value="Send" class="btn btn-primary">Do ittttt</button>
	</form>
      </div>
    </div>
  </div>
</div>

<!-- New Match Modal -->
<div class="modal fade" id="newMatchModal" tabindex="-1" role="dialog" aria-labelledby="myMatchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">New Match!</h4>
      </div>
      <div class="modal-body">
        <div id="modal-intro"></div><br>
        <form id="new-thread-form" method="POST">
				  <textarea form="new-thread-form" name="textarea" rows="10" cols="50" placeholder="Start the conversation!" required></textarea><br><br>
				  {% csrf_token %}
			    <button type="submit" class="btn btn-primary new-match-accept" id="new-match-accept">Do ittttt</button>
				</form>
      </div>
    </div>
  </div>
</div>

<!-- No match modal -->
<div class="modal fade" id="noNewMatchModal" tabindex="-1" role="dialog" aria-labelledby="myNoMatchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">No New Matches :(</h4>
      </div>
      <div class="modal-body">
        <div id="modal-apology"> It doesn't look like there are any new people for us to match you with. Check back soon, or else we can just email you the minute you've got someone to talk to!</div><br>
      </div>
    </div>
  </div>
</div>

<!-- Refer a friend modal -->
<div class="modal fade" id="referAFriendModal" tabindex="-1" role="dialog" aria-labelledby="myReferAFriendModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	<h4 class="modal-title" id="myModalLabel">Refer a Friend!</h4>
      </div>
      <div class="modal-body">
	<p><b>re&middot; fer</b>: <i>verb</i> <br>
	  1. To direct the attention or thoughts of <br>
	  2. To mention or allude to <br>
	  3. To be a dope human and spread the Sagely luv <3</p>
	<form id="refer-a-friend-form" method="POST" action="/chat/refer_friend/">
	  {% csrf_token %}
	  <input class="form-control" id="refer_text1" type="text" name="refer-name" id="refer-a-friend-name" placeholder="Friend's Name"/>
	  <input class="form-control" type="text" name="refer-email" id="refer-a-friend-email" placeholder="Friend's email" /><br>
	  <button type="submit" value="Send" class="btn btn-primary">REFERRRRRRR</button>
	</form>
      </div>
    </div>
  </div>
</div>

<!-- Report a person modal -->
<div class="modal fade" id="reportAPersonModal" tabindex="-1" role="dialog" aria-labelledby="reportAPersonModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	<h4 class="modal-title" id="myModalLabel">Report a Person</h4>
      </div>
      <div class="modal-body">
	<form id="report-a-person-form" method="POST" action="/chat/report_person/">
	  {% csrf_token %}
	  <p>Did someone cause a kerfuffle?  What would you like to say about the following hooligan: <div id="members-to-report"></div></p>
	  <br>
	  <textarea rows="4" class="form-control" type="text" name="report-issue-text" id="report-issue-text" placeholder="Tell us what happened :(" ></textarea><br>
	  <button type="submit" value="Send" class="btn btn-primary">LET US AT 'EM</button>
	</form>
      </div>
    </div>
  </div>
</div>

<!-- Submit Feedback modal -->
<div class="modal fade" id="sendFeedbackModal" tabindex="-1" role="dialog" aria-labelledby="sendFeedbackModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	<h4 class="modal-title" id="myModalLabel">Submit Feedback</h4>
      </div>
      <div class="modal-body">
	<form id="report-a-person-form" method="POST" action="/chat/submit_feedback/">
	  {% csrf_token %}
	  <p>Tell us what's on your mind!</p>
	  <br>
	  <textarea rows="4" class="form-control" type="text" name="send-feedback-text" id="send-feedback-text" placeholder="Thank you!" ></textarea><br>
	  <button type="submit" value="Send" class="btn btn-primary">Submit</button>
	</form>
      </div>
    </div>
  </div>
</div>

<!-- Nudge a person modal -->
<div class="modal fade" id="nudgeAPersonModal" tabindex="-1" role="dialog" aria-labelledby="nudgeAPersonModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	<h4 class="modal-title" id="myModalLabel">Nudge a Person</h4>
      </div>
      <div class="modal-body">
	<form id="nudge-a-person-form" method="POST" action=".">
	  {% csrf_token %}
	  <p>Someone a little slow on the response?  Would you like us to give the following a little nudge for you? <div id="members-to-nudge"></div></p>
	  <br>
	  <button type="submit" value="Send" class="btn btn-primary" id="nudge-a-person-button">Wink wink, nudge nudge :)</button>
	</form>
      </div>
    </div>
  </div>
</div>

{% endblock %}
