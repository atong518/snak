{% extends "user/base.html" %}
{% load static %}

{% block extrastyle %}
  <link rel="stylesheet" type="text/css" href="{% static 'messages/css/chat.css' %}" />
{% endblock %}


{% block content %}
<script>
  function populateThread(threadId) {
    // hide all threads
    $('.thread').each(function() {
      $(this).hide();
    });

    // show individual thread
    id = "#thread-" + threadId;
    $(id).show();

    // deactivate all thread links
    $('.inbox-message').each(function() {
      $(this).removeClass("active-link");
    });

    // activate individual thread link
    thread_link = "#thread-link-" + threadId;
    $(thread_link).addClass("active-link");
  
    // scroll down
    scrollDown();
  }

  function sendMessage() {
    // get id of the thread that is activated
    var selectedThreadId = $(".active-link").attr("id");

    // ensure that there is a thread activated
    if (typeof selectedThreadId == "undefined") {
      alert(selectedThreadId);
    }
    else {
      selectedThreadId = selectedThreadId.split("-")[2];
    }

    // get text of message to be sent
    var message_text = $("#message-input-box").val();

    $.ajax({
        url : "send_chat_message/", // the endpoint
        type : "POST", // http method
        data : { message_text : message_text,
                 thread_id : selectedThreadId }, // data sent with the post request

        // handle a successful response
        success : function(json) {
            if (typeof json.ignore != "undefined") return;
            var prev_messages = $('#thread-' + selectedThreadId).html();
            var append = '<div class="row" style="margin-top: 10px;">';

            if (json.sender == "{{ user.email }}") {
              append += '<div class="btn btn-primary pull-right disabled">';
            }
            else {
              append += '<div class="btn btn-default disabled">';
	    }
	    append += json.text + '</div></div>';
            console.log("append:" + append);
            $('#thread-' + selectedThreadId).html(prev_messages + append);

            $('#message-input-box').val(''); // remove the value from the input
            $('#message-content').html();
            console.log(json); // log the returned json to the console
            console.log("huzzah"); // another sanity check
    
            // scroll down!
            scrollDown();
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            $('#message-content').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
    });
  }
</script>
<script type="text/javascript" src="{% static 'messages/js/chat.js' %}"></script>

<div class="row" style="height:100%; padding: 10px;" id="chat-room">
  <!--left navbar-->
  <div class="col-md-2 well" id="inbox">    
    <!--chat menu dropdown-->
    <div class="btn-group btn-group-justified" id="btn-chat-menu">
      <div class="btn-group" id="btn-chat-menu">
	<button type="button" class="btn btn-success btn-large dropdown-toggle" id="chatmenu" data-toggle="dropdown" aria-expanded="false">
	  Menu <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu">
	  <li><a href="#">Settings</a></li>
	  <li><a href="#">Advanced Match</a></li>
	  <li><a href="#">Adjust Interests</a></li>
	  <li><a href="#">Submit Feedback</a></li>
	  <li><a href="#">Refer a Friend</a></li>
	</ul>
      </div>
    </div>      
    <!--inbox-->
    <ul class="nav nav-pills nav-stacked">
    {% for thread in inbox_threads %}
      <li role="presentation"><a class="inbox-message" href="#" 
				 onclick="populateThread({{ thread.pk }})" 
				 id="thread-link-{{ thread.pk }}">{{ thread }}</a></li>
    {% endfor %}
    </ul>

    <div class="btn btn-danger btn-large" id="btn-match-me">Match Me!</div>
  </div>
  <!--current message-->
  <div class="col-md-10 well box">
    <!--plus menu-->
    <div class="row" style="padding-right: 20px; padding-top: 5px; margin-bottom: 5px;">
      <div class="dropdown">
	<button class="btn btn-success dropdown-toggle pull-right" type="button" id="plusmenu" data-toggle="dropdown" aria-expanded="false">+</button>
	<ul class="dropdown-menu pull-right" role="menu" aria-labelledby="plusmenu">
	  <li><a href="#">Add a Person</a></li>
	  <li><a href="#">Report Conversation</a></li>
	  <li><a href="#">Nudge Person</a></li>
	</ul>
	</div>
    </div>
    <div id="message-box" >
      <!--previously sent/received messages-->
      <div id="message-content">
	{% for thread in inbox_threads %}
 	<div id="thread-{{ thread.pk }}" class="thread">
          {% for message in thread.message_set.all %}
	  <div class="row" style="margin-top: 10px">
            {% if message.sender == user %}
	    <div class="btn btn-primary disabled pull-right">{{ message }}</div>
            {% else %}
            <div class="btn btn-default disabled">{{ message }}</div>
            {% endif %}
	  </div>
	  {% endfor %}
	</div>
	{% endfor %}
      </div>
    </div>
    <form id="send-message-form" method="POST">
      {% csrf_token %}
      <div class="input-group" id="send-message-row">
	<input class="form-control" type="text" id="message-input-box">
	<span class="input-group-btn">
	  <input type="submit" id="btn-send-message" class="btn btn-success" value="Send"/>
	</span>
      </div>
    </form>
  </div>
</div>



{% endblock %}
